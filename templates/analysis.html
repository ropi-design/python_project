{% extends "base.html" %}

{% block title %}分析結果 - InstaInsight{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        分析結果
                    </h1>
                    <p class="text-muted mb-0">ファイル: {{ filename }}</p>
                </div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>新しいファイルをアップロード
                </a>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="fas fa-images text-primary"></i>
                </div>
                <div class="kpi-content">
                    <h3 class="kpi-value">{{ stats.total_posts }}</h3>
                    <p class="kpi-label">総投稿数</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="fas fa-percentage text-success"></i>
                </div>
                <div class="kpi-content">
                    <h3 class="kpi-value">{{ "%.2f"|format(stats.avg_er) }}%</h3>
                    <p class="kpi-label">平均ER</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="fas fa-heart text-danger"></i>
                </div>
                <div class="kpi-content">
                    <h3 class="kpi-value">{{ "%.0f"|format(stats.avg_likes) }}</h3>
                    <p class="kpi-label">平均いいね数</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="fas fa-comments text-info"></i>
                </div>
                <div class="kpi-content">
                    <h3 class="kpi-value">{{ "%.0f"|format(stats.avg_comments) }}</h3>
                    <p class="kpi-label">平均コメント数</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ranking-tab" data-bs-toggle="tab" data-bs-target="#ranking" type="button">
                        <i class="fas fa-trophy me-2"></i>ランキング
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hourly-tab" data-bs-toggle="tab" data-bs-target="#hourly" type="button">
                        <i class="fas fa-clock me-2"></i>時間帯分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button">
                        <i class="fas fa-calendar me-2"></i>曜日分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hashtag-tab" data-bs-toggle="tab" data-bs-target="#hashtag" type="button">
                        <i class="fas fa-hashtag me-2"></i>ハッシュタグ分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button">
                        <i class="fas fa-chart-line me-2"></i>エンゲージメント指標
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="suggestions-tab" data-bs-toggle="tab" data-bs-target="#suggestions" type="button">
                        <i class="fas fa-lightbulb me-2"></i>改善提案
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="content-analysis-tab" data-bs-toggle="tab" data-bs-target="#content-analysis" type="button">
                        <i class="fas fa-search me-2"></i>内容分析
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="analysisTabContent">
                <!-- Ranking Tab -->
                <div class="tab-pane fade show active" id="ranking" role="tabpanel">
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-trophy me-2"></i>上位ランキング
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if not top_rankings.empty %}
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>投稿ID</th>
                                                        <th>投稿日時</th>
                                                        <th>ER(%)</th>
                                                        <th>エンゲージメント</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for _, row in top_rankings.iterrows() %}
                                                    <tr>
                                                        <td>{{ row.get('post_id', 'N/A') }}</td>
                                                        <td>{{ row.get('posted_at', 'N/A') }}</td>
                                                        <td>{{ "%.2f"|format(row.get('er_percentage', 0)) }}</td>
                                                        <td>{{ "%.0f"|format(row.get('engagement_total', 0)) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">有効なエンゲージメント率データがありません</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>下位ランキング
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if not bottom_rankings.empty %}
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>投稿ID</th>
                                                        <th>投稿日時</th>
                                                        <th>ER(%)</th>
                                                        <th>エンゲージメント</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for _, row in bottom_rankings.iterrows() %}
                                                    <tr>
                                                        <td>{{ row.get('post_id', 'N/A') }}</td>
                                                        <td>{{ row.get('posted_at', 'N/A') }}</td>
                                                        <td>{{ "%.2f"|format(row.get('er_percentage', 0)) }}</td>
                                                        <td>{{ "%.0f"|format(row.get('engagement_total', 0)) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">有効なエンゲージメント率データがありません</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hourly Analysis Tab -->
                <div class="tab-pane fade" id="hourly" role="tabpanel">
                    <div class="mt-4">
                        {% if hourly_chart %}
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-clock me-2"></i>時間帯別平均エンゲージメント率
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="hourly-chart" style="min-height: 400px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">読み込み中...</span>
                                            </div>
                                            <p class="mt-2 text-muted">チャートを読み込み中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                時間帯別のデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Weekly Analysis Tab -->
                <div class="tab-pane fade" id="weekly" role="tabpanel">
                    <div class="mt-4">
                        {% if weekly_chart %}
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-calendar me-2"></i>曜日別平均エンゲージメント率
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="weekly-chart" style="min-height: 400px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">読み込み中...</span>
                                            </div>
                                            <p class="mt-2 text-muted">チャートを読み込み中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                曜日別のデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Hashtag Analysis Tab -->
                <div class="tab-pane fade" id="hashtag" role="tabpanel">
                    <div class="mt-4">
                        {% if hashtag_chart %}
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-hashtag me-2"></i>ハッシュタグ使用頻度
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="hashtag-chart" style="min-height: 400px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">読み込み中...</span>
                                            </div>
                                            <p class="mt-2 text-muted">チャートを読み込み中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                ハッシュタグのデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Engagement Metrics Tab -->
                <div class="tab-pane fade" id="metrics" role="tabpanel">
                    <div class="mt-4">
                        {% if engagement_metrics and not engagement_metrics.error %}
                            <div class="row">
                                {% for metric_type, metrics in engagement_metrics.items() %}
                                <div class="col-12 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-chart-line me-2"></i>{{ metric_type }}
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- 計算式を上部に大きく表示 -->
                                            <div class="row mb-4">
                                                <div class="col-12">
                                                    <div class="alert alert-info border-0 shadow-sm" style="position: relative; z-index: 10; background-color: #d1ecf1 !important; border-left: 4px solid #17a2b8 !important;">
                                                        <h5 class="text-primary mb-2" style="font-size: 1.1rem;">
                                                            <i class="fas fa-calculator me-2"></i>計算式
                                                        </h5>
                                                        <p class="mb-0 h6" style="font-weight: bold; color: #0c5460; font-size: 1.1rem; line-height: 1.4;">
                                                            {% if metric_type == "フォロワー数ベース" %}
                                                                （いいね＋コメント＋保存）÷ フォロワー数 × 100
                                                            {% elif metric_type == "インプレッション数ベース" %}
                                                                （いいね＋コメント＋保存）÷ インプレッション数 × 100
                                                            {% else %}
                                                                {{ metrics.計算式 }}
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- 統計値の表示 -->
                                            <div class="row">
                                                <div class="col-md-3 mb-3">
                                                    <div class="text-center">
                                                        <h4 class="text-primary">{{ metrics.平均ER }}</h4>
                                                        <p class="mb-0 text-muted">平均ER</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <div class="text-center">
                                                        <h4 class="text-success">{{ metrics.最高ER }}</h4>
                                                        <p class="mb-0 text-muted">最高ER</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <div class="text-center">
                                                        <h4 class="text-warning">{{ metrics.最低ER }}</h4>
                                                        <p class="mb-0 text-muted">最低ER</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <div class="text-center">
                                                        <h4 class="text-info">{{ metrics.中央値ER }}</h4>
                                                        <p class="mb-0 text-muted">中央値ER</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                エンゲージメント指標を計算するためのデータが不足しています。
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Improvement Suggestions Tab -->
                <div class="tab-pane fade" id="suggestions" role="tabpanel">
                    <div class="mt-4">
                        {% if improvement_suggestions and not improvement_suggestions.error %}
                            <!-- Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h3 class="text-primary">{{ improvement_suggestions.total_suggestions }}</h3>
                                            <p class="mb-0">総提案数</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card border-danger">
                                        <div class="card-body text-center">
                                            <h3 class="text-danger">{{ improvement_suggestions.high_priority }}</h3>
                                            <p class="mb-0">高優先度</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h3 class="text-warning">{{ improvement_suggestions.medium_priority }}</h3>
                                            <p class="mb-0">中優先度</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h3 class="text-success">{{ improvement_suggestions.low_priority }}</h3>
                                            <p class="mb-0">低優先度</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Suggestions List -->
                            <div class="row">
                                {% for suggestion in improvement_suggestions.suggestions %}
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                {% if suggestion.priority == "高" %}
                                                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                                {% elif suggestion.priority == "中" %}
                                                    <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                {% else %}
                                                    <i class="fas fa-info-circle text-success me-2"></i>
                                                {% endif %}
                                                {{ suggestion.title }}
                                            </h5>
                                            <span class="badge 
                                                {% if suggestion.priority == "高" %}bg-danger
                                                {% elif suggestion.priority == "中" %}bg-warning
                                                {% else %}bg-success{% endif %}">
                                                {{ suggestion.priority }}優先度
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <h6 class="text-muted mb-2">{{ suggestion.category }}</h6>
                                                    <p class="mb-3">{{ suggestion.description }}</p>
                                                    <div class="alert alert-light">
                                                        <strong>推奨アクション:</strong> {{ suggestion.recommendation }}
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="text-center">
                                                        {% if suggestion.priority == "高" %}
                                                            <i class="fas fa-fire text-danger" style="font-size: 3rem; opacity: 0.3;"></i>
                                                        {% elif suggestion.priority == "中" %}
                                                            <i class="fas fa-clock text-warning" style="font-size: 3rem; opacity: 0.3;"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success" style="font-size: 3rem; opacity: 0.3;"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                改善提案を生成するためのデータが不足しています。
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Content Analysis Tab -->
                <div class="tab-pane fade" id="content-analysis" role="tabpanel">
                    <div class="mt-4">
                        {% if content_recommendations and not content_recommendations.error %}
                            <!-- Content Analysis Summary -->
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h3 class="text-info">{{ content_recommendations.total_recommendations }}</h3>
                                            <p class="mb-0">内容分析提案数</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card border-danger">
                                        <div class="card-body text-center">
                                            <h3 class="text-danger">{{ content_recommendations.high_priority }}</h3>
                                            <p class="mb-0">高優先度</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h3 class="text-warning">{{ content_recommendations.medium_priority }}</h3>
                                            <p class="mb-0">中優先度</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content Analysis Results -->
                            <div class="row">
                                {% for recommendation in content_recommendations.recommendations %}
                                <div class="col-12 mb-4">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                {% if recommendation.priority == "高" %}
                                                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                                {% elif recommendation.priority == "中" %}
                                                    <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                {% else %}
                                                    <i class="fas fa-info-circle text-success me-2"></i>
                                                {% endif %}
                                                {{ recommendation.title }}
                                            </h5>
                                            <span class="badge 
                                                {% if recommendation.priority == "高" %}bg-danger
                                                {% elif recommendation.priority == "中" %}bg-warning
                                                {% else %}bg-success{% endif %}">
                                                {{ recommendation.priority }}優先度
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <h6 class="text-muted mb-2">{{ recommendation.category }}</h6>
                                                    <p class="mb-3">{{ recommendation.description }}</p>
                                                    <div class="alert alert-light">
                                                        <strong>推奨アクション:</strong> {{ recommendation.recommendation }}
                                                    </div>
                                                    
                                                    {% if recommendation.action_items %}
                                                    <div class="mt-3">
                                                        <h6 class="text-primary mb-2">
                                                            <i class="fas fa-tasks me-2"></i>具体的なアクション項目:
                                                        </h6>
                                                        <ul class="list-group list-group-flush">
                                                            {% for item in recommendation.action_items %}
                                                            <li class="list-group-item d-flex align-items-center">
                                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                                {{ item }}
                                                            </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="text-center">
                                                        {% if recommendation.priority == "高" %}
                                                            <i class="fas fa-fire text-danger" style="font-size: 3rem; opacity: 0.3;"></i>
                                                        {% elif recommendation.priority == "中" %}
                                                            <i class="fas fa-clock text-warning" style="font-size: 3rem; opacity: 0.3;"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success" style="font-size: 3rem; opacity: 0.3;"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Content Analysis Insights -->
                            {% if content_recommendations.content_analysis %}
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-chart-bar me-2"></i>詳細分析結果
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                {% if content_recommendations.content_analysis.hashtag_patterns %}
                                                <div class="col-md-6 mb-3">
                                                    <h6 class="text-primary">ハッシュタグ分析結果</h6>
                                                    {% if content_recommendations.content_analysis.hashtag_patterns.optimal_count %}
                                                    <p class="mb-1">
                                                        <strong>最適なハッシュタグ数:</strong> 
                                                        {{ content_recommendations.content_analysis.hashtag_patterns.optimal_count.count }}個
                                                        (平均ER: {{ content_recommendations.content_analysis.hashtag_patterns.optimal_count.avg_er }}%)
                                                    </p>
                                                    {% endif %}
                                                    
                                                    {% if content_recommendations.content_analysis.hashtag_patterns.effective_tags %}
                                                    <p class="mb-1"><strong>効果的なハッシュタグ:</strong></p>
                                                    <ul class="list-unstyled">
                                                        {% for tag, stats in content_recommendations.content_analysis.hashtag_patterns.effective_tags.items() %}
                                                        <li class="mb-1">
                                                            <span class="badge bg-success me-1">#{{ tag }}</span>
                                                            <small class="text-muted">(平均ER: {{ stats.mean }}%, 使用回数: {{ stats.count }})</small>
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                
                                                {% if content_recommendations.content_analysis.time_patterns %}
                                                <div class="col-md-6 mb-3">
                                                    <h6 class="text-primary">時間帯分析結果</h6>
                                                    {% for category, data in content_recommendations.content_analysis.time_patterns.items() %}
                                                    <p class="mb-1">
                                                        <strong>
                                                            {% if category == "morning" %}朝（6-11時）
                                                            {% elif category == "afternoon" %}午後（12-17時）
                                                            {% elif category == "evening" %}夕方（18-23時）
                                                            {% elif category == "night" %}夜間（0-5時）
                                                            {% endif %}:
                                                        </strong>
                                                        平均ER {{ data.avg_er }}% (投稿数: {{ data.post_count }})
                                                    </p>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                内容分析を実行するためのデータが不足しています。
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ページ読み込み完了後にチャートを描画
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing charts...');
        
        // 計算式は完全に静的に表示されるため、JavaScript保護は不要
        
        // 計算式は完全に静的に表示されるため、DOM監視は不要
        
        // 時間帯別チャート
        {% if hourly_chart %}
        try {
            const hourlyData = {{ hourly_chart|safe }};
            console.log('Hourly chart data:', hourlyData);
            if (hourlyData && hourlyData.data && hourlyData.layout) {
                // 読み込み中表示を削除
                document.getElementById('hourly-chart').innerHTML = '';
                Plotly.newPlot('hourly-chart', hourlyData.data, hourlyData.layout);
                console.log('Hourly chart rendered successfully');
            } else {
                console.error('Invalid hourly chart data structure');
            }
        } catch (error) {
            console.error('Error rendering hourly chart:', error);
        }
        {% endif %}
        
        // 曜日別チャート
        {% if weekly_chart %}
        try {
            const weeklyData = {{ weekly_chart|safe }};
            console.log('Weekly chart data:', weeklyData);
            if (weeklyData && weeklyData.data && weeklyData.layout) {
                // 読み込み中表示を削除
                document.getElementById('weekly-chart').innerHTML = '';
                Plotly.newPlot('weekly-chart', weeklyData.data, weeklyData.layout);
                console.log('Weekly chart rendered successfully');
            } else {
                console.error('Invalid weekly chart data structure');
            }
        } catch (error) {
            console.error('Error rendering weekly chart:', error);
        }
        {% endif %}
        
        // ハッシュタグチャート
        {% if hashtag_chart %}
        try {
            const hashtagData = {{ hashtag_chart|safe }};
            console.log('Hashtag chart data:', hashtagData);
            if (hashtagData && hashtagData.data && hashtagData.layout) {
                // 読み込み中表示を削除
                document.getElementById('hashtag-chart').innerHTML = '';
                Plotly.newPlot('hashtag-chart', hashtagData.data, hashtagData.layout);
                console.log('Hashtag chart rendered successfully');
            } else {
                console.error('Invalid hashtag chart data structure');
            }
        } catch (error) {
            console.error('Error rendering hashtag chart:', error);
        }
        {% endif %}
    });
    
    // タブ切り替え時のチャート再描画
    {% if hourly_chart %}
    document.getElementById('hourly-tab').addEventListener('shown.bs.tab', function () {
        try {
            const chartData = {{ hourly_chart|safe }};
            if (chartData && chartData.data && chartData.layout) {
                // 読み込み中表示を削除
                document.getElementById('hourly-chart').innerHTML = '';
                Plotly.newPlot('hourly-chart', chartData.data, chartData.layout);
            }
        } catch (error) {
            console.error('Error re-rendering hourly chart:', error);
        }
    });
    {% endif %}
    
    {% if weekly_chart %}
    document.getElementById('weekly-tab').addEventListener('shown.bs.tab', function () {
        try {
            const chartData = {{ weekly_chart|safe }};
            if (chartData && chartData.data && chartData.layout) {
                // 読み込み中表示を削除
                document.getElementById('weekly-chart').innerHTML = '';
                Plotly.newPlot('weekly-chart', chartData.data, chartData.layout);
            }
        } catch (error) {
            console.error('Error re-rendering weekly chart:', error);
        }
    });
    {% endif %}
    
    {% if hashtag_chart %}
    document.getElementById('hashtag-tab').addEventListener('shown.bs.tab', function () {
        try {
            const chartData = {{ hashtag_chart|safe }};
            if (chartData && chartData.data && chartData.layout) {
                // 読み込み中表示を削除
                document.getElementById('hashtag-chart').innerHTML = '';
                Plotly.newPlot('hashtag-chart', chartData.data, chartData.layout);
            }
        } catch (error) {
            console.error('Error re-rendering hashtag chart:', error);
        }
    });
    {% endif %}
    
    // エンゲージメント指標タブのイベントハンドラー（計算式は静的に表示されるため保護不要）
    document.getElementById('metrics-tab').addEventListener('shown.bs.tab', function () {
        console.log('Metrics tab shown');
    });
</script>
{% endblock %}
